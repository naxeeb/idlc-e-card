<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel – Greeting Card Editor</title>
  <!-- Bootstrap CSS for improved UI -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <!-- jQuery UI CSS for draggable -->
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/smoothness/jquery-ui.css">
  <style>
    /* Container for the image and draggable boxes */
    #card-container {
      position: relative;
      display: inline-block;
      border: 1px solid #ccc;
      margin-top: 20px;
    }
    /* The image scales down while keeping its aspect ratio */
    #card-image {
      max-width: 100%;
      height: auto;
      display: block;
    }
    /* Draggable text overlays */
    .draggable-text {
      position: absolute;
      padding: 5px;
      background: rgba(255, 255, 255, 0.7);
      border: 1px dashed #333;
      cursor: move;
      user-select: none;
    }
  </style>
</head>
<body>
<div class="container">
  <h1 class="mt-4">Admin Panel – Greeting Card Editor</h1>
  
  <!-- Upload Form and Live Editor Settings -->
  <form method="post" enctype="multipart/form-data">
    <!-- Step 1: Upload Template Image -->
    <div class="card mt-4">
      <div class="card-header">
        Step 1: Upload Template Image
      </div>
      <div class="card-body">
        <div class="form-group">
          <label>Upload Image (JPG or PNG):</label>
          <input type="file" name="template_image" accept=".jpg,.jpeg,.png" class="form-control-file">
        </div>
      </div>
    </div>
    
    <!-- Step 2: Set Text Styles & Preview Text -->
    <div class="card mt-4">
      <div class="card-header">
        Step 2: Set Text Styles &amp; Preview Text
      </div>
      <div class="card-body">
        <div class="row">
          <!-- Name Settings -->
          <div class="col-md-6">
            <h5>Name Text Settings</h5>
            <div class="form-group">
              <label for="preview_name_text">Preview Text:</label>
              <input type="text" id="preview_name_text" value="Name Here" class="form-control">
            </div>
            <div class="form-group">
              <label for="name_font">Font (CSS font-family):</label>
              <input type="text" id="name_font" name="name_font" value="{{ config.name.font }}" class="form-control">
            </div>
            <div class="form-group">
              <label for="name_size">Font Size (px):</label>
              <input type="number" id="name_size" name="name_size" value="{{ config.name.size }}" class="form-control">
            </div>
            <div class="form-group">
              <label for="name_color">Color:</label>
              <input type="color" id="name_color" name="name_color" value="{{ config.name.color }}" class="form-control">
            </div>
            <div class="form-group">
              <label for="name_alignment">Alignment:</label>
              <select id="name_alignment" name="name_alignment" class="form-control">
                <option value="left" {% if config.name.alignment=='left' %}selected{% endif %}>Left</option>
                <option value="center" {% if config.name.alignment=='center' %}selected{% endif %}>Center</option>
                <option value="right" {% if config.name.alignment=='right' %}selected{% endif %}>Right</option>
              </select>
            </div>
          </div>
          <!-- Designation Settings -->
          <div class="col-md-6">
            <h5>Designation Text Settings</h5>
            <div class="form-group">
              <label for="preview_designation_text">Preview Text:</label>
              <input type="text" id="preview_designation_text" value="Designation Here" class="form-control">
            </div>
            <div class="form-group">
              <label for="designation_font">Font (CSS font-family):</label>
              <input type="text" id="designation_font" name="designation_font" value="{{ config.designation.font }}" class="form-control">
            </div>
            <div class="form-group">
              <label for="designation_size">Font Size (px):</label>
              <input type="number" id="designation_size" name="designation_size" value="{{ config.designation.size }}" class="form-control">
            </div>
            <div class="form-group">
              <label for="designation_color">Color:</label>
              <input type="color" id="designation_color" name="designation_color" value="{{ config.designation.color }}" class="form-control">
            </div>
            <div class="form-group">
              <label for="designation_alignment">Alignment:</label>
              <select id="designation_alignment" name="designation_alignment" class="form-control">
                <option value="left" {% if config.designation.alignment=='left' %}selected{% endif %}>Left</option>
                <option value="center" {% if config.designation.alignment=='center' %}selected{% endif %}>Center</option>
                <option value="right" {% if config.designation.alignment=='right' %}selected{% endif %}>Right</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Hidden Fields for Coordinates -->
    <input type="hidden" id="name_x" name="name_x" value="{{ config.name.x }}">
    <input type="hidden" id="name_y" name="name_y" value="{{ config.name.y }}">
    <input type="hidden" id="designation_x" name="designation_x" value="{{ config.designation.x }}">
    <input type="hidden" id="designation_y" name="designation_y" value="{{ config.designation.y }}">
    
    <button type="submit" class="btn btn-primary mt-3">Save Template and Settings</button>
  </form>
  
  {% if config.template_image %}
  <!-- Step 3: Drag and Drop -->
  <div class="card mt-4">
    <div class="card-header">
      Step 3: Drag and Drop to Set Text Positions
    </div>
    <div class="card-body">
      <div id="card-container">
        <!-- The template image (PNG or JPG) -->
        <img id="card-image" src="/{{ config.template_image }}" alt="Greeting Card">
        <!-- Draggable text boxes -->
        <div id="name-text" class="draggable-text" style="left: {{ config.name.x }}px; top: {{ config.name.y }}px;">
          {{ config.name.text if config.name.text is defined else "Name Here" }}
        </div>
        <div id="designation-text" class="draggable-text" style="left: {{ config.designation.x }}px; top: {{ config.designation.y }}px;">
          {{ config.designation.text if config.designation.text is defined else "Designation Here" }}
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Load jQuery first, then jQuery UI, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script>
  $(document).ready(function() {
    // Function to initialize draggable functionality
    function initDraggables() {
      var img = document.getElementById("card-image");
      // Calculate scale factors for X and Y axes
      var naturalWidth = img.naturalWidth;
      var naturalHeight = img.naturalHeight;
      var displayedWidth = $("#card-image").width();
      var displayedHeight = $("#card-image").height();
      var scaleFactorX = naturalWidth / displayedWidth;
      var scaleFactorY = naturalHeight / displayedHeight;
      console.log("Scale Factors:", scaleFactorX, scaleFactorY);
      
      // Apply jQuery UI draggable to the text boxes
      $(".draggable-text").draggable({
        containment: "#card-container",
        stop: function(event, ui) {
          if (this.id === "name-text") {
            $("#name_x").val(Math.round(ui.position.left * scaleFactorX));
            $("#name_y").val(Math.round(ui.position.top * scaleFactorY));
          } else if (this.id === "designation-text") {
            $("#designation_x").val(Math.round(ui.position.left * scaleFactorX));
            $("#designation_y").val(Math.round(ui.position.top * scaleFactorY));
          }
        }
      });
    }
    
    // Initialize draggable functionality once the image has loaded.
    $("#card-image").on("load", function() {
      initDraggables();
    }).each(function() {
      if(this.complete) {
        $(this).trigger("load");
      }
    });
    
    // Live preview updates for text boxes
    $('#preview_name_text').on('input', function() {
      $('#name-text').text($(this).val());
    });
    $('#preview_designation_text').on('input', function() {
      $('#designation-text').text($(this).val());
    });
    
    // Live update styling for name and designation boxes
    function updateNameStyle() {
      $('#name-text').css({
        'font-family': $('#name_font').val(),
        'font-size': $('#name_size').val() + 'px',
        'color': $('#name_color').val(),
        'text-align': $('#name_alignment').val()
      });
    }
    function updateDesignationStyle() {
      $('#designation-text').css({
        'font-family': $('#designation_font').val(),
        'font-size': $('#designation_size').val() + 'px',
        'color': $('#designation_color').val(),
        'text-align': $('#designation_alignment').val()
      });
    }
    
    // Attach change/input events for live styling updates
    $('#name_font, #name_size, #name_color, #name_alignment').on('input change', updateNameStyle);
    $('#designation_font, #designation_size, #designation_color, #designation_alignment').on('input change', updateDesignationStyle);
    
    // Initialize styles on page load
    updateNameStyle();
    updateDesignationStyle();
  });
</script>
</body>
</html>
